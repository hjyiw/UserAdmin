# 权限类型与数据权限说明文档

## 一、权限标识说明

### 1. 权限标识格式

系统中的权限标识采用三级结构，格式为：`系统:模块:操作`，例如 `system:user:list`

每一级的含义如下：
- 第一级：系统/应用标识，表示权限所属的系统或应用
- 第二级：模块标识，表示权限所属的功能模块
- 第三级：操作标识，表示具体的操作权限类型

### 2. 常见权限标识说明

#### 用户管理相关权限

| 权限标识 | 说明 |
| ------- | ---- |
| system:user:list | 用户列表查看权限 |
| system:user:query | 用户详情查询权限 |
| system:user:add | 用户新增权限 |
| system:user:edit | 用户编辑权限 |
| system:user:remove | 用户删除权限 |

#### 角色管理相关权限

| 权限标识 | 说明 |
| ------- | ---- |
| system:role:list | 角色列表查看权限 |
| system:role:query | 角色详情查询权限 |
| system:role:add | 角色新增权限 |
| system:role:edit | 角色编辑权限 |
| system:role:remove | 角色删除权限 |

#### 部门管理相关权限

| 权限标识 | 说明 |
| ------- | ---- |
| system:dept:list | 部门列表查看权限 |
| system:dept:query | 部门详情查询权限 |
| system:dept:add | 部门新增权限 |
| system:dept:edit | 部门编辑权限 |
| system:dept:remove | 部门删除权限 |

### 3. 特殊权限标识

| 权限标识 | 说明 |
| ------- | ---- |
| *:*:* | 所有权限，通常分配给超级管理员 |

## 二、数据权限说明

数据权限是指用户可以访问哪些数据范围的权限控制机制。在系统中，数据权限主要通过 `sys_user_data_scope` 表和用户的 `dataScope` 属性来控制。

### 1. 数据权限类型

系统中定义了5种数据权限类型，存储在用户信息的 `dataScope` 字段中：

| 数据权限类型值 | 类型名称 | 说明 |
| ------------ | ------- | ---- |
| 1 | DATA_SCOPE_ALL | 全部数据权限，可以访问所有部门的数据 |
| 2 | DATA_SCOPE_CUSTOM | 自定义数据权限，可以访问用户被分配的指定部门的数据 |
| 3 | DATA_SCOPE_DEPT | 本部门数据权限，只能访问用户所属部门的数据 |
| 4 | DATA_SCOPE_DEPT_AND_CHILD | 本部门及以下数据权限，可以访问用户所属部门及其下级部门的数据 |
| 5 | DATA_SCOPE_SELF | 仅本人数据权限，只能访问用户自己创建的数据 |

### 2. 数据权限实现方式

#### 数据库表设计

数据权限主要通过以下表实现：

1. `sys_user` 表：
   - `dataScope` 字段：存储用户的数据权限类型（1-5）

2. `sys_user_data_scope` 表：
   - 当用户的数据权限类型为"自定义数据权限"（`dataScope=2`）时，在此表中存储用户可访问的部门ID列表
   - 字段结构：`user_id`（用户ID）和 `dept_id`（部门ID）

#### 数据权限的应用场景

1. **全部数据权限（1）**：
   - 适用对象：超级管理员
   - 示例：管理员可以查看和管理所有部门的用户信息

2. **自定义数据权限（2）**：
   - 适用对象：需要访问特定部门数据的角色，如项目经理
   - 示例：项目经理可以查看前端组和后端组的数据，但无法查看测试部门的数据
   - 实现：在 `sys_user_data_scope` 表中为用户ID=4的项目经理添加了dept_id=5和dept_id=6的记录

3. **本部门数据权限（3）**：
   - 适用对象：普通部门主管
   - 示例：测试部门主管只能查看测试部门的数据

4. **本部门及以下数据权限（4）**：
   - 适用对象：高级部门主管
   - 示例：研发部门主管可以查看研发部门及其下属的前端组和后端组的数据

5. **仅本人数据权限（5）**：
   - 适用对象：普通员工
   - 示例：市场专员只能查看自己创建或负责的数据

### 3. 数据权限在代码中的使用

在后端实现中，数据权限通常通过以下方式应用：

1. **SQL查询条件动态拼接**：
   - 根据用户的数据权限类型，动态拼接SQL查询条件
   - 例如，当用户具有"本部门"权限时，会在查询条件中添加 `dept_id = 用户部门ID`

2. **注解方式**：
   - 在需要进行数据权限控制的方法上添加注解
   - 通过AOP方式在执行方法前自动处理数据权限

3. **示例代码**：

```java
// 根据数据权限类型构建查询条件
public void buildDataScopeFilter(User currentUser, String deptAlias) {
    // 如果是超级管理员，不进行数据过滤
    if (currentUser.isAdmin()) {
        return;
    }
    
    StringBuilder sqlBuilder = new StringBuilder();
    
    // 根据不同的数据权限类型构建SQL条件
    String dataScope = currentUser.getDataScope();
    if (DATA_SCOPE_ALL.equals(dataScope)) {
        // 全部数据权限，不进行过滤
    } else if (DATA_SCOPE_CUSTOM.equals(dataScope)) {
        // 自定义数据权限
        sqlBuilder.append(String.format(
            " OR %s.dept_id IN (SELECT dept_id FROM sys_user_data_scope WHERE user_id = %s)",
            deptAlias, currentUser.getUserId()));
    } else if (DATA_SCOPE_DEPT.equals(dataScope)) {
        // 本部门数据权限
        sqlBuilder.append(String.format(
            " OR %s.dept_id = %s",
            deptAlias, currentUser.getDeptId()));
    } else if (DATA_SCOPE_DEPT_AND_CHILD.equals(dataScope)) {
        // 本部门及以下数据权限
        sqlBuilder.append(String.format(
            " OR %s.dept_id IN (SELECT dept_id FROM sys_dept WHERE dept_id = %s OR find_in_set(%s, ancestors))",
            deptAlias, currentUser.getDeptId(), currentUser.getDeptId()));
    } else if (DATA_SCOPE_SELF.equals(dataScope)) {
        // 仅本人数据权限
        sqlBuilder.append(String.format(
            " OR %s.create_by = %s",
            deptAlias, currentUser.getUserId()));
    }
    
    // 将构建的SQL条件添加到查询条件中
    if (StringUtils.isNotBlank(sqlBuilder.toString())) {
        BaseEntity baseEntity = (BaseEntity) joinPoint.getArgs()[0];
        baseEntity.getParams().put("dataScope", " AND (" + sqlBuilder.substring(4) + ")");
    }
}
```

## 三、权限与数据权限的结合使用

在实际应用中，功能权限和数据权限通常结合使用：

1. **功能权限控制访问入口**：
   - 首先检查用户是否具有某个功能的操作权限，如 `system:user:list`
   - 如果没有权限，直接拒绝访问

2. **数据权限控制数据范围**：
   - 在通过功能权限检查后，再根据用户的数据权限过滤数据
   - 确保用户只能看到其权限范围内的数据

3. **示例场景**：
   - 用户A具有 `system:user:list` 权限，表示可以访问用户列表页面
   - 用户A的数据权限类型为"本部门"，表示只能看到自己部门的用户数据
   - 当用户A访问用户列表时，系统会返回其所在部门的用户数据，而不是所有用户数据

## 四、权限设计最佳实践

1. **权限粒度适中**：
   - 权限粒度过细会导致权限管理复杂
   - 权限粒度过粗会导致权限控制不够精确
   - 建议按照"模块+操作"的方式设计权限

2. **数据权限与业务结合**：
   - 数据权限应当根据业务需求设计
   - 不同模块可能需要不同的数据权限控制策略

3. **权限缓存优化**：
   - 权限验证是高频操作，应当合理使用缓存
   - 用户权限变更时及时更新缓存

4. **前后端权限一致**：
   - 前端根据权限控制UI元素的显示
   - 后端必须进行权限验证，不能仅依赖前端控制 